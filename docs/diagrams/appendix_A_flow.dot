digraph UE4T_RESIDUAL_FLOW_KO {
  graph  [rankdir=LR, bgcolor="#FFFFFF", nodesep=0.8, ranksep=1.1, fontname="Helvetica", splines=ortho];
  node   [shape=box, style="rounded,filled", fillcolor="#EAF3FF", color="#2C6EBB", penwidth=1.4, fontname="Helvetica", fontsize=12, margin="0.10,0.06"];
  edge   [color="#333333", arrowsize=0.8, penwidth=1.3, fontname="Helvetica", fontsize=10];

  subgraph cluster_main {
    label="Residual Handling (NORM + ΣΔ 하이브리드)";
    style="filled,rounded"; color="#EEEEEE"; fontcolor="#444444";

    x      [label="입력 x (샘플)"];
    b      [label="기준 b (EMA)"];
    diff   [label="차분 d = x - b"];
    scale  [label="UE 스케일 2^E"];
    norm   [label="NORM (q)"];
    dhat   [label="d̂ = deq(q)·2^E"];
    racc   [label="잔차 누산기 r"];
    sdp    [label="ΣΔ 펄스 +1"];
    sdm    [label="ΣΔ 펄스 -1"];

    {rank=same; x; b}
  }

  // main flow
  x    -> diff;
  b    -> diff;
  diff -> scale   [label="스케일 적용"];
  scale-> norm    [label="NORM 토큰"];
  norm -> dhat    [label="deFP + 2^E"];

  // residual feedback
  diff -> racc    [label="d"];
  dhat -> racc    [label="d̂"];
  racc -> scale   [label="r += (d - d̂)\n임계 도달 시 발화", style=dashed, color="#888888"];

  // sigma-delta emissions
  racc -> sdp     [label="|r| ≥ λ0·2^E·K & T_emit", color="#FF9900"];
  racc -> sdm     [label="조건 대칭", style=dashed, color="#FF9900"];

  // styling for SD nodes
  sdp  [fillcolor="#DFF7E7", color="#2E8B57"];
  sdm  [fillcolor="#DFF7E7", color="#2E8B57"];
}
