digraph TFSD8_SYNC_AUTO_VERTICAL {
  graph  [rankdir=TB, bgcolor="#F9F9F9", nodesep=0.9, ranksep=1.1, fontname="Helvetica", overlap=false];
  node   [shape=box, style="rounded,filled", fillcolor="#EAF3FF", color="#2C6EBB",
          penwidth=1.4, fontname="Helvetica", fontsize=13, margin="0.10,0.06"];
  edge   [color="#333333", arrowsize=0.8, penwidth=1.3, fontname="Helvetica", fontsize=11];

  subgraph cluster_enc {
    label="Encoder"; style="filled,rounded"; color="#E6E6E6"; fontcolor="#444";
    e_in [label="input x"];
    e_b  [label="b(EMA)"];
    e_d  [label="d = x - b"];
    e_q  [label="FP8 quantize"];
    e_E  [label="E(TFSD8)"];
  }
  subgraph cluster_tok {
    label="Token Stream"; style="rounded"; color="#DDDDDD"; fontcolor="#444";
    tok [label="Tokens: NORM / MAX / MIN / SCALE"];
  }
  subgraph cluster_dec {
    label="Decoder"; style="filled,rounded"; color="#E6E6E6"; fontcolor="#444";
    d_E [label="E sync"]; d_q [label="deFP8(q)"];
    d_rec [label="reconstruct dÌ‚ = deFP8(q) Â· 2^E"]; d_b [label="b(EMA)"];
    d_out [label="restore xÌ‚ = b + dÌ‚"];
  }

  e_in -> e_d; e_b -> e_d; e_d -> e_q; e_E -> e_q [label="Emit SCALE"];
  e_q -> tok [label="NORM"]; e_E -> tok [label="SCALE"];
  tok -> d_q [label="NORM/MAX/MIN"]; tok -> d_E [label="SCALE"];
  d_q -> d_rec; d_E -> d_rec; d_b -> d_out; d_rec -> d_out;
}
